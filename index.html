<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bitcoin DCA & Crash-Assistent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #050505;
      color: #f7f7f7;
    }
    h1, h2 {
      color: #FFD700;
      margin-bottom: 0.5rem;
    }
    .card {
      border: 1px solid #333;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 16px;
      background: #111;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    input[type="number"], input[readonly] {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #000;
      color: #f7f7f7;
      font-size: 0.95rem;
    }
    input:focus {
      outline: none;
      border-color: #FFD700;
    }
    button {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #FFD700;
      background: #000;
      color: #FFD700;
      font-weight: 600;
      font-size: 1rem;
    }
    button:active {
      background: #222;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 120px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 4px;
    }
    .badge-green { background: #044; color: #8f8; }
    .badge-yellow { background: #443; color: #FFEB3B; }
    .badge-grey { background: #333; color: #bbb; }
    .small {
      font-size: 0.8rem;
      color: #aaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 4px 6px;
      text-align: right;
    }
    th {
      background: #151515;
      color: #ddd;
    }
    td:first-child, th:first-child {
      text-align: left;
    }
    .hint {
      font-size: 0.9rem;
      margin-top: 6px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>â‚¿ DCA & Crash-Assistent</h1>
  <p class="small">
    BTC-Preis wird automatisch geladen. MA200 & 200WMA trÃ¤gst du z.B. aus TradingView ein.
    Crash-Budget ist manuell â€“ die App hilft dir nur beim Rechnen.
  </p>

  <!-- 1. Basis-Einstellungen -->
  <div class="card">
    <h2>1. Basis-Einstellungen</h2>
    <label>Monatliches DCA-Budget (â‚¬)
      <input type="number" id="monthlyDca" value="310" step="1">
    </label>
    <div class="row">
      <div>
        <label>Crash-Budget aktuell (â‚¬)
          <input type="number" id="crashBudget" value="0" step="50">
        </label>
      </div>
      <div>
        <label>Aktueller BTC-Preis (â‚¬) <span class="small">(per Button laden oder manuell setzen)</span>
          <input type="number" id="currentPrice" value="0" step="100" readonly>
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>MA200 (Tage, â‚¬)
          <input type="number" id="ma200" value="" step="100">
        </label>
      </div>
      <div>
        <label>200WMA (Wochen, â‚¬)
          <input type="number" id="wma200" value="" step="100">
        </label>
      </div>
    </div>
    <button onclick="fetchLivePrice()">BTC-Preis laden</button>
  </div>

  <!-- 2. Markt-Zone -->
  <div class="card">
    <h2>2. Markt-Zone</h2>
    <div id="zoneInfo" class="hint"></div>
  </div>

  <!-- 3. Limit-DCA-Plan -->
  <div class="card">
    <h2>3. DCA-Limit-Plan (dieser Monat)</h2>
    <p class="small">
      Standard-Limits: âˆ’3 %, âˆ’6 %, âˆ’10 %. In der Deep-Zone kommt ein extra Limit bei âˆ’15 % dazu.
      Die Verteilung der BetrÃ¤ge hÃ¤ngt von der Zone ab.
    </p>
    <table id="limitTable">
      <thead>
        <tr>
          <th>Stufe</th>
          <th>Preis (â‚¬)</th>
          <th>Betrag (â‚¬)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="hint" id="limitHint"></p>
  </div>

  <!-- 4. Crash-Level-Plan -->
  <div class="card">
    <h2>4. Crash-Level (vom aktuellen Preis)</h2>
    <p class="small">
      Crash-Budget wird auf âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % vom aktuellen Preis verteilt.
      Die Verteilung ist je nach Zone konservativer oder aggressiver.
    </p>
    <table id="crashTable">
      <thead>
        <tr>
          <th>Level</th>
          <th>FallhÃ¶he</th>
          <th>Kurs (â‚¬)</th>
          <th>Einsatz (â‚¬)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="hint" id="crashHint"></p>
  </div>

  <!-- 5. Restbudget-Manager -->
  <div class="card">
    <h2>5. Restbudget-Manager (Monatsende)</h2>
    <p class="small">
      Trage ein, wie viel du in diesem Monat (DCA + eventuelle Market-KÃ¤ufe) tatsÃ¤chlich investiert hast.
      Die App zeigt dir, wie der Restbetrag je nach Zone behandelt werden kann (Market vs. Crash-Budget).
    </p>
    <label>TatsÃ¤chlich investiert im Monat (â‚¬)
      <input type="number" id="spentThisMonth" value="0" step="10">
    </label>
    <p class="hint" id="restHint"></p>
  </div>

  <!-- 6. Konkrete Handlung -->
  <div class="card">
    <h2>6. Konkrete Handlung (Zusammenfassung)</h2>
    <div id="actionText" class="hint"></div>
  </div>

<script>
function formatEuro(num) {
  if (isNaN(num)) return "-";
  return num.toLocaleString("de-DE", {minimumFractionDigits: 0, maximumFractionDigits: 0});
}
function formatPrice(num) {
  if (isNaN(num)) return "-";
  return num.toLocaleString("de-DE", {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

// Einstellungen speichern / laden
function saveSettings() {
  const settings = {
    monthlyDca: document.getElementById("monthlyDca").value,
    crashBudget: document.getElementById("crashBudget").value,
    ma200: document.getElementById("ma200").value,
    wma200: document.getElementById("wma200").value,
    spentThisMonth: document.getElementById("spentThisMonth").value
  };
  try {
    localStorage.setItem("btcDcaSettingsV2", JSON.stringify(settings));
  } catch (e) {}
}

function loadSettings() {
  try {
    const raw = localStorage.getItem("btcDcaSettingsV2");
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.monthlyDca) document.getElementById("monthlyDca").value = s.monthlyDca;
    if (s.crashBudget) document.getElementById("crashBudget").value = s.crashBudget;
    if (s.ma200) document.getElementById("ma200").value = s.ma200;
    if (s.wma200) document.getElementById("wma200").value = s.wma200;
    if (s.spentThisMonth) document.getElementById("spentThisMonth").value = s.spentThisMonth;
  } catch (e) {}
}

// BTC-Preis laden
async function fetchLivePrice() {
  const priceInput = document.getElementById("currentPrice");
  try {
    priceInput.value = "â€¦";
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    const price = data.bitcoin.eur;
    priceInput.value = Math.round(price);
  } catch (e) {
    priceInput.value = 0;
    alert("BTC-Preis konnte nicht geladen werden:\n" + e.message + "\nDu kannst ihn manuell eintragen.");
  }
  recalculate();
}

// Hauptlogik
function recalculate() {
  const monthlyDca = parseFloat(document.getElementById("monthlyDca").value) || 0;
  const crashBudget = parseFloat(document.getElementById("crashBudget").value) || 0;
  const price = parseFloat(document.getElementById("currentPrice").value) || 0;
  const ma200 = parseFloat(document.getElementById("ma200").value) || 0;
  const wma200 = parseFloat(document.getElementById("wma200").value) || 0;
  const spentThisMonth = parseFloat(document.getElementById("spentThisMonth").value) || 0;

  saveSettings();

  // 1) Markt-Zone bestimmen
  const zoneInfo = document.getElementById("zoneInfo");
  let zoneText = "";
  let zoneBadge = "";
  let zone = "unknown";

  if (price <= 0 || ma200 <= 0 || wma200 <= 0) {
    zoneText = "Bitte BTC-Preis, MA200 und 200WMA eintragen. MA-Werte kannst du z.B. aus TradingView holen.";
    zoneBadge = "<span class='badge badge-grey'>unbekannt</span>";
    zone = "unknown";
  } else {
    if (price < wma200) {
      zone = "deep";
      zoneBadge = "<span class='badge badge-green'>DEEP â€“ historisch gÃ¼nstig (unter 200WMA)</span>";
      zoneText = "Bitcoin liegt UNTER dem 200-Wochen-Durchschnitt. Historisch eine der stÃ¤rksten Kaufzonen.";
    } else if (price < ma200) {
      zone = "cheap";
      zoneBadge = "<span class='badge badge-yellow'>GÃœNSTIG â€“ unter MA200</span>";
      zoneText = "Bitcoin liegt UNTER dem 200-Tage-Durchschnitt. Gute Zone fÃ¼r DCA + erste Crash-KÃ¤ufe.";
    } else {
      zone = "normal";
      zoneBadge = "<span class='badge badge-grey'>NORMAL</span>";
      zoneText = "Bitcoin liegt ÃœBER dem MA200. Normaler/bullischer Bereich.";
    }
  }
  zoneInfo.innerHTML = zoneBadge + "<br>" + zoneText;

  // 2) DCA-Limit-Plan
  const tbodyLimit = document.querySelector("#limitTable tbody");
  tbodyLimit.innerHTML = "";
  let dcaLevels = [];
  if (price > 0 && monthlyDca > 0 && zone !== "unknown") {
    if (zone === "deep") {
      // 4 Limits: -3, -6, -10, -15 ; 25% jeweils
      dcaLevels = [
        { label: "-3 %",  drop: 0.03, part: 0.25 },
        { label: "-6 %",  drop: 0.06, part: 0.25 },
        { label: "-10 %", drop: 0.10, part: 0.25 },
        { label: "-15 %", drop: 0.15, part: 0.25 }
      ];
    } else if (zone === "cheap") {
      // etwas mehr Gewicht auf tieferen Levels
      dcaLevels = [
        { label: "-3 %",  drop: 0.03, part: 0.35 },
        { label: "-6 %",  drop: 0.06, part: 0.35 },
        { label: "-10 %", drop: 0.10, part: 0.30 }
      ];
    } else {
      // normal: Standard-Verteilung 40/35/25
      dcaLevels = [
        { label: "-3 %",  drop: 0.03, part: 0.40 },
        { label: "-6 %",  drop: 0.06, part: 0.35 },
        { label: "-10 %", drop: 0.10, part: 0.25 }
      ];
    }

    dcaLevels.forEach(l => {
      const limitPrice = price * (1 - l.drop);
      const amount = monthlyDca * l.part;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.label}</td>
        <td>${formatPrice(limitPrice)}</td>
        <td>${formatEuro(amount)}</td>
      `;
      tbodyLimit.appendChild(tr);
    });

    let hint = "Zu Monatsbeginn legst du diese Limit-Orders an (mit Post Only, wenn verfÃ¼gbar).";
    if (zone === "deep") {
      hint += "\nIn der Deep-Zone bekommst du ein zusÃ¤tzliches Limit bei âˆ’15 %, das einen Teil deines Budgets gezielt sehr tief platziert.";
    }
    document.getElementById("limitHint").innerText = hint;
  } else {
    document.getElementById("limitHint").innerText =
      "Bitte Monatsbudget, BTC-Preis und MA-Werte eintragen, um die Limit-Orders zu berechnen.";
  }

  // 3) Crash-Level-Plan (vom aktuellen Preis)
  const tbodyCrash = document.querySelector("#crashTable tbody");
  tbodyCrash.innerHTML = "";
  const crashHint = document.getElementById("crashHint");

  if (crashBudget <= 0 || price <= 0 || zone === "unknown") {
    crashHint.innerText =
      "FÃ¼r konkrete Crash-Levels trage bitte ein Crash-Budget, BTC-Preis und gÃ¼ltige MA-Werte ein.";
  } else {
    const baseLevels = [
      { label: "Level 1", dropLabel: "âˆ’20 %", drop: 0.20 },
      { label: "Level 2", dropLabel: "âˆ’30 %", drop: 0.30 },
      { label: "Level 3", dropLabel: "âˆ’40 %", drop: 0.40 },
      { label: "Level 4", dropLabel: "âˆ’50 %", drop: 0.50 }
    ];
    let parts;
    if (zone === "deep") {
      // Deep: aggressiver
      parts = [0.15, 0.20, 0.25, 0.40];
    } else if (zone === "cheap") {
      // GÃ¼nstig: ausgewogen
      parts = [0.10, 0.25, 0.25, 0.40];
    } else { // normal
      // Normal: eher vorsichtig
      parts = [0.05, 0.20, 0.30, 0.45];
    }

    baseLevels.forEach((lvl, idx) => {
      const part = parts[idx];
      const levelPrice = price * (1 - lvl.drop);
      const amount = crashBudget * part;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${lvl.label}</td>
        <td>${lvl.dropLabel}</td>
        <td>${formatPrice(levelPrice)}</td>
        <td>${formatEuro(amount)}</td>
      `;
      tbodyCrash.appendChild(tr);
    });

    let txt = "Diese Tabelle zeigt dir, wie du dein Crash-Budget auf âˆ’20 %, âˆ’30 %, âˆ’40 % und âˆ’50 % vom aktuellen Preis verteilen kannst.\n";
    if (zone === "deep") {
      txt += "In der Deep-Zone ist der Einsatz aggressiver â€“ hier holen Crash-KÃ¤ufe historisch besonders viele Sats.";
    } else if (zone === "cheap") {
      txt += "In der gÃ¼nstigen Zone ist der Einsatz moderat â€“ du nutzt Crash-KÃ¤ufe, hÃ¤ltst aber Reserven fÃ¼r noch tiefere Phasen.";
    } else {
      txt += "In der Normal-Zone ist die Verteilung konservativer â€“ setze Crash-Budget nur bei echten, starken RÃ¼cksetzern ein.";
    }
    crashHint.innerText = txt;
  }

  // 4) Restbudget-Manager
  const restHint = document.getElementById("restHint");
  if (monthlyDca <= 0) {
    restHint.innerText = "Trage zuerst dein monatliches DCA-Budget ein.";
  } else if (zone === "unknown" || price <= 0) {
    restHint.innerText = "Zone ist noch unbekannt. Bitte BTC-Preis, MA200 und 200WMA eintragen.";
  } else if (spentThisMonth <= 0) {
    restHint.innerText =
      "Trage hier ein, wie viel du in diesem Monat (DCA + eventuelle Market-KÃ¤ufe) wirklich investiert hast.\n" +
      "Die App berechnet dann, wie du den Restbetrag je nach Zone zwischen Market-Kauf und Crash-Budget aufteilen kannst.";
  } else {
    let rest = monthlyDca - spentThisMonth;
    if (rest < 0) rest = 0;
    let restToCrash = 0;
    let restToMarketExtra = 0;

    if (zone === "normal") {
      restToCrash = rest;
      restToMarketExtra = 0;
    } else if (zone === "cheap") {
      restToCrash = rest * 0.5;
      restToMarketExtra = rest * 0.5;
    } else if (zone === "deep") {
      restToCrash = 0;
      restToMarketExtra = rest;
    }

    const newCrashBudget = crashBudget + restToCrash;
    let text =
      "Monatliches DCA-Budget: " + formatEuro(monthlyDca) + " â‚¬\n" +
      "TatsÃ¤chlich investiert (laut deiner Eingabe): " + formatEuro(spentThisMonth) + " â‚¬\n" +
      "Restbetrag: " + formatEuro(rest) + " â‚¬\n\n";

    if (zone === "normal") {
      text +=
        "Zone: NORMAL\n" +
        "Empfehlung:\n" +
        "â€¢ Restbetrag vollstÃ¤ndig dem Crash-Budget zufÃ¼hren.\n" +
        "â€¢ ZusÃ¤tzliche Market-KÃ¤ufe sind hier nicht nÃ¶tig.\n\n";
    } else if (zone === "cheap") {
      text +=
        "Zone: GÃœNSTIG (unter MA200)\n" +
        "Empfehlung:\n" +
        "â€¢ Ca. 50 % des Restbetrags als zusÃ¤tzlichen Market-Kauf verwenden.\n" +
        "â€¢ Ca. 50 % des Restbetrags in dein Crash-Budget verschieben.\n\n";
    } else if (zone === "deep") {
      text +=
        "Zone: DEEP (unter 200WMA)\n" +
        "Empfehlung:\n" +
        "â€¢ Den Restbetrag komplett als zusÃ¤tzlichen Market-Kauf nutzen.\n" +
        "â€¢ Crash-Budget hier lieber fÃ¼r die gestaffelten Crash-Levels (âˆ’20 % bis âˆ’50 %) aufheben.\n\n";
    }

    text +=
      "Empfohlene Aufteilung des Restbetrags:\n" +
      "â€¢ ZusÃ¤tzlicher Market-Kauf: " + formatEuro(restToMarketExtra) + " â‚¬\n" +
      "â€¢ Crash-Budget-ZufÃ¼hrung: " + formatEuro(restToCrash) + " â‚¬\n\n" +
      "Wenn du die Empfehlung umsetzt, wÃ¤re dein neues theoretisches Crash-Budget: " +
      formatEuro(newCrashBudget) + " â‚¬ (du musst den Wert oben manuell anpassen, wenn du das so Ã¼bernehmen mÃ¶chtest).";

    restHint.innerText = text;
  }

  // 5) Konkrete Handlung (Zusammenfassung)
  const actionEl = document.getElementById("actionText");
  let action = "";

  if (price <= 0 || zone === "unknown") {
    action =
      "1. Trage BTC-Preis (oder lade ihn) und deine MA-Werte (MA200, 200WMA) ein.\n" +
      "2. Lege dann die DCA-Limits laut Tabelle an.\n" +
      "3. Wenn du ein Crash-Budget hast, nutze die Crash-Level-Tabelle als Plan.";
  } else {
    if (zone === "normal") {
      action =
        "âšª Zone: NORMAL\n\n" +
        "Zu Monatsbeginn:\n" +
        "â€¢ Setze deine DCA-Limits bei âˆ’3 %, âˆ’6 % und âˆ’10 % gemÃ¤ÃŸ Tabelle.\n" +
        "â€¢ Setze Crash-Limit-Orders bei âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % mit den vorgeschlagenen BetrÃ¤gen.\n\n" +
        "Im Monatsverlauf:\n" +
        "â€¢ Lass die Limits einfach arbeiten. Crash-Limits werden nur aktiv, wenn der Markt wirklich deutlich fÃ¤llt.\n\n" +
        "Am Monatsende:\n" +
        "â€¢ Ermittle, wie viel du tatsÃ¤chlich investiert hast.\n" +
        "â€¢ Den Restbetrag kannst du komplett in dein Crash-Budget schieben (kein zusÃ¤tzlicher Market-Kauf nÃ¶tig).\n";
    } else if (zone === "cheap") {
      action =
        "ðŸŸ¡ Zone: GÃœNSTIG (unter MA200)\n\n" +
        "Zu Monatsbeginn:\n" +
        "â€¢ Setze deine DCA-Limits wie angezeigt (etwas mehr Gewicht auf den tieferen Levels).\n" +
        "â€¢ Crash-Limits bei âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % wie in der Tabelle.\n\n" +
        "Im Monatsverlauf:\n" +
        "â€¢ Normales DCA lÃ¤uft weiter.\n" +
        "â€¢ Wenn Crash-Level ausgelÃ¶st werden, kannst du dein Crash-Budget schrittweise einsetzen.\n\n" +
        "Am Monatsende:\n" +
        "â€¢ Restbetrag etwa 50/50 auf Market-Kauf und Crash-Budget aufteilen (siehe Restbudget-Manager).\n";
    } else if (zone === "deep") {
      action =
        "ðŸŸ¢ Zone: DEEP (unter 200WMA â€“ historisch sehr gÃ¼nstig)\n\n" +
        "Zu Monatsbeginn:\n" +
        "â€¢ Setze deine DCA-Limits bei âˆ’3 %, âˆ’6 %, âˆ’10 % und das Extra-Limit bei âˆ’15 %.\n" +
        "â€¢ Setze Crash-Limits bei âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % mit den vorgeschlagenen BetrÃ¤gen.\n\n" +
        "Im Monatsverlauf:\n" +
        "â€¢ Dies ist eine der stÃ¤rksten Zonen fÃ¼r langfristige BTC-KÃ¤ufe.\n" +
        "â€¢ DCA und Crash-KÃ¤ufe kÃ¶nnen parallel laufen. Bleibe trotzdem gestaffelt und schieÃŸe nicht alles auf einmal.\n\n" +
        "Am Monatsende:\n" +
        "â€¢ Nutze den Restbetrag vollstÃ¤ndig fÃ¼r zusÃ¤tzliche Market-KÃ¤ufe (kein Rest ins Crash-Budget verschieben).\n" +
        "â€¢ Dein Crash-Budget setzt du weiter gemÃ¤ÃŸ der Crash-Level-Tabelle ein, wenn der Markt noch tiefer fÃ¤llt.\n";
    } else {
      action = "Zone unklar. PrÃ¼fe deine Eingaben.";
    }
  }

  actionEl.innerText = action;
}

// Events
window.addEventListener("load", () => {
  loadSettings();
  recalculate();

  ["monthlyDca","crashBudget","ma200","wma200","spentThisMonth"].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", recalculate);
  });
});
</script>
</body>
</html>
