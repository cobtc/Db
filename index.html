<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bitcoin DCA & Crash-Assistent PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
    :root {
      --accent: #f7931a;
      --accent-soft: #f7c66a;
      --bg: #050505;
      --card-bg: #111;
      --border: #333;
      --text-main: #f7f7f7;
      --text-muted: #aaaaaa;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text-main);
    }

    h1 {
      color: var(--accent);
      margin-bottom: 0.25rem;
      font-size: 1.4rem;
    }

    h2 {
      color: var(--accent-soft);
      margin-bottom: 0.4rem;
      font-size: 1.1rem;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 16px;
      background: radial-gradient(circle at top left, #181818 0, #050505 55%);
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
    }

    input[type="number"], input[readonly] {
      width: 100%;
      padding: 7px 9px;
      margin-top: 4px;
      border-radius: 9px;
      border: 1px solid #444;
      background: #000;
      color: var(--text-main);
      font-size: 0.95rem;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(247,147,26,0.5);
    }

    button {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: #000;
      color: var(--accent-soft);
      font-weight: 600;
      font-size: 0.95rem;
    }

    button.secondary {
      border-color: #444;
      color: #ddd;
    }

    button:active {
      background: #222;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1 1 140px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 4px;
    }

    .badge-green { background: #044; color: #8f8; }
    .badge-yellow { background: #443; color: #FFEB3B; }
    .badge-grey { background: #333; color: #bbb; }

    .zone-normal {
      border-left: 4px solid #666;
    }
    .zone-cheap {
      border-left: 4px solid #fdd835;
    }
    .zone-deep {
      border-left: 4px solid #66bb6a;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }

    th, td {
      border: 1px solid #333;
      padding: 4px 6px;
      text-align: right;
    }

    th {
      background: #151515;
      color: #ddd;
    }

    td:first-child, th:first-child {
      text-align: left;
    }

    .hint {
      font-size: 0.9rem;
      margin-top: 6px;
      white-space: pre-line;
    }

    .muted {
      color: var(--text-muted);
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .actions-row button {
      flex: 1 1 140px;
    }

  </style>
</head>
<body>
  <h1>â‚¿ DCA & Crash-Assistent PRO</h1>
  <div class="subtitle">
    Version 1.3 â€“ DVCB-Strategie, Zonenlogik, Crash-Budget-Helfer, CPR/Pivots & Bullrun-Mindestkauf.
  </div>

  <!-- 1. Basis-Einstellungen -->
  <div class="card">
    <h2>1. Basis-Einstellungen</h2>
    <p class="small">
      Monatsbudget = dein regelmÃ¤ÃŸiges DCA-Geld. Crash-Budget = Extra-Munition fÃ¼r echte Dumps (nur manuell befÃ¼llt).
      MA200 & 200WMA trÃ¤gst du z.B. aus TradingView (BTC/EUR) ein.
    </p>
    <label>Monatliches DCA-Budget (â‚¬)
      <input type="number" id="monthlyDca" value="310" step="1">
    </label>
    <div class="row">
      <div>
        <label>Crash-Budget aktuell (â‚¬)
          <input type="number" id="crashBudget" value="0" step="50">
        </label>
      </div>
      <div>
        <label>Aktueller BTC-Preis (â‚¬) <span class="small">(per Button oder manuell)</span>
          <input type="number" id="currentPrice" value="0" step="100">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>MA200 (Tage, â‚¬)
          <input type="number" id="ma200" value="" step="100">
        </label>
      </div>
      <div>
        <label>200WMA (Wochen, â‚¬)
          <input type="number" id="wma200" value="" step="100">
        </label>
      </div>
    </div>
    <div class="actions-row">
      <button onclick="fetchLivePrice()">BTC-Preis laden</button>
    </div>
  </div>

  <!-- 2. Markt-Zone -->
  <div class="card" id="zoneCard">
    <h2>2. Markt-Zone</h2>
    <div id="zoneInfo" class="hint"></div>
  </div>

  <!-- 3. Limit-DCA-Plan -->
  <div class="card">
    <h2>3. DCA-Limit-Plan (dieser Monat)</h2>
    <p class="small">
      Standard-Limits: âˆ’3 %, âˆ’6 %, âˆ’10 %. In der Deep-Zone kommt ein Extra-Limit bei âˆ’15 % dazu
      (alle Limits gestaffelt nach Zone und optional feinjustiert durch CPR/Pivots).
    </p>
    <table id="limitTable">
      <thead>
        <tr>
          <th>Stufe</th>
          <th>Preis (â‚¬)</th>
          <th>Betrag (â‚¬)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="hint" id="limitHint"></p>
  </div>

  <!-- 4. Crash-Level-Plan -->
  <div class="card">
    <h2>4. Crash-Level (vom aktuellen Preis)</h2>
    <p class="small">
      Crash-Budget wird auf âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % vom aktuellen Preis verteilt.
      Die Verteilung wird je nach Zone konservativer oder aggressiver â€“ und kann zusÃ¤tzlich vom CPR-Bias beeinflusst werden.
    </p>
    <table id="crashTable">
      <thead>
        <tr>
          <th>Level</th>
          <th>FallhÃ¶he</th>
          <th>Kurs (â‚¬)</th>
          <th>Einsatz (â‚¬)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="hint" id="crashHint"></p>
  </div>

  <!-- 5. Restbudget-Manager -->
  <div class="card">
    <h2>5. Restbudget-Manager (Monatsende)</h2>
    <p class="small">
      Trage ein, wie viel du in diesem Monat (DCA + eventuelle Market-KÃ¤ufe) tatsÃ¤chlich investiert hast.
      Die App zeigt dir, wie der Restbetrag je nach Zone zwischen Market-Kauf und Crash-Budget aufgeteilt werden kann.
      Im Bullrun (Normal-Zone) und 0 â‚¬ investiert: ca. 25 % Market-Kauf, Rest ins Crash-Budget.
    </p>
    <label>TatsÃ¤chlich investiert im Monat (â‚¬)
      <input type="number" id="spentThisMonth" value="0" step="10">
    </label>
    <div class="actions-row">
      <button class="secondary" onclick="resetForNewMonth()">Neuen Monat starten (DCA-ZÃ¤hler zurÃ¼cksetzen)</button>
      <button onclick="applyRecommendedCrashBudget()">Empfohlenes Crash-Budget Ã¼bernehmen</button>
    </div>
    <p class="hint" id="restHint"></p>
  </div>

  <!-- 6. Konkrete Handlung -->
  <div class="card">
    <h2>6. Konkrete Handlung (Monats-Workflow)</h2>
    <div id="actionText" class="hint"></div>
  </div>

  <!-- 7. Smart-Assistent -->
  <div class="card">
    <h2>7. Smart-Assistent</h2>
    <div id="assistantText" class="hint muted"></div>
  </div>

  <!-- 8. CPR/Pivot-Analyse (optional) -->
  <div class="card">
    <h2>8. CPR & Pivot-Feinsteuerung (optional)</h2>
    <p class="small">
      Trage die CPR- und Pivot-Levels (z.B. aus einem CPR-Indikator in TradingView, BTC/EUR) ein.
      Wenn Werte gesetzt sind, nutzt die App den Bias (R-/S-Levels), um DCA und Crash-Verteilungen leicht zu optimieren.
    </p>
    <div class="row">
      <div>
        <label>BC (Bottom Central Pivot)
          <input type="number" id="cprBC" step="10">
        </label>
      </div>
      <div>
        <label>PP (Pivot Point)
          <input type="number" id="cprPP" step="10">
        </label>
      </div>
      <div>
        <label>TC (Top Central Pivot)
          <input type="number" id="cprTC" step="10">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>S1
          <input type="number" id="cprS1" step="10">
        </label>
      </div>
      <div>
        <label>S2
          <input type="number" id="cprS2" step="10">
        </label>
      </div>
      <div>
        <label>S3
          <input type="number" id="cprS3" step="10">
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>R1
          <input type="number" id="cprR1" step="10">
        </label>
      </div>
      <div>
        <label>R2
          <input type="number" id="cprR2" step="10">
        </label>
      </div>
      <div>
        <label>R3
          <input type="number" id="cprR3" step="10">
        </label>
      </div>
    </div>
    <p class="hint" id="cprInfo"></p>
  </div>

<script>
function formatEuro(num) {
  if (isNaN(num)) return "-";
  return num.toLocaleString("de-DE", {minimumFractionDigits: 0, maximumFractionDigits: 0});
}
function formatPrice(num) {
  if (isNaN(num)) return "-";
  return num.toLocaleString("de-DE", {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

let lastRecommendedCrashBudget = null;

// CPR-Kontext bestimmen
function getCprContext(price) {
  const bc = parseFloat(document.getElementById("cprBC").value);
  const pp = parseFloat(document.getElementById("cprPP").value);
  const tc = parseFloat(document.getElementById("cprTC").value);
  const s1 = parseFloat(document.getElementById("cprS1").value);
  const s2 = parseFloat(document.getElementById("cprS2").value);
  const s3 = parseFloat(document.getElementById("cprS3").value);
  const r1 = parseFloat(document.getElementById("cprR1").value);
  const r2 = parseFloat(document.getElementById("cprR2").value);
  const r3 = parseFloat(document.getElementById("cprR3").value);

  const cprInfo = document.getElementById("cprInfo");
  if (isNaN(bc) || isNaN(pp) || isNaN(tc) || bc <= 0 || pp <= 0 || tc <= 0) {
    cprInfo.innerText = "CPR/Pivot ist aktuell inaktiv. Trage BC, PP und TC (und optional R/S-Level) ein, um die Feinsteuerung zu aktivieren.";
    return {enabled:false, bias:"none", widthClass:"none", desc:""};
  }

  let widthPct = null;
  let widthClass = "normal";
  if (tc > bc) {
    widthPct = ((tc - bc) / pp) * 100;
    if (widthPct < 0.7) widthClass = "narrow";
    else if (widthPct > 1.5) widthClass = "wide";
    else widthClass = "normal";
  }

  let bias = "neutral";
  if (!isNaN(price) && price > 0) {
    if (!isNaN(s2) && price <= s2) {
      bias = "strongDown";
    } else if (!isNaN(s1) && price <= s1) {
      bias = "down";
    } else if (!isNaN(r2) && price >= r2) {
      bias = "strongUp";
    } else if (!isNaN(r1) && price >= r1) {
      bias = "up";
    } else if (!isNaN(pp)) {
      if (price < pp) bias = "down";
      else bias = "up";
    }
  }

  let desc = "CPR aktiv.\n";
  if (widthPct !== null) {
    desc += "CPR-Breite: " + widthPct.toFixed(2) + " % (" + widthClass + ").\n";
  }

  if (bias === "strongDown") {
    desc += "Bias: Stark abwÃ¤rts orientiert (Preis eher im Bereich S2/S3 oder darunter). Tiefe Dips und Crash-Levels sind realistischer.";
  } else if (bias === "down") {
    desc += "Bias: Leicht abwÃ¤rts (unter PP, im Bereich S1).";
  } else if (bias === "up") {
    desc += "Bias: Leicht aufwÃ¤rts (Ã¼ber PP, im Bereich R1).";
  } else if (bias === "strongUp") {
    desc += "Bias: Stark aufwÃ¤rts (im Bereich R2/R3 oder darÃ¼ber). Tiefe Crash-Level werden eventuell lÃ¤nger nicht bedient.";
  } else {
    desc += "Bias: Neutral.";
  }

  cprInfo.innerText = desc;
  return {enabled:true, bias, widthClass, desc, widthPct};
}

// Einstellungen speichern / laden
function saveSettings() {
  const settings = {
    monthlyDca: document.getElementById("monthlyDca").value,
    crashBudget: document.getElementById("crashBudget").value,
    ma200: document.getElementById("ma200").value,
    wma200: document.getElementById("wma200").value,
    spentThisMonth: document.getElementById("spentThisMonth").value,
    currentPrice: document.getElementById("currentPrice").value,
    cprBC: document.getElementById("cprBC").value,
    cprPP: document.getElementById("cprPP").value,
    cprTC: document.getElementById("cprTC").value,
    cprS1: document.getElementById("cprS1").value,
    cprS2: document.getElementById("cprS2").value,
    cprS3: document.getElementById("cprS3").value,
    cprR1: document.getElementById("cprR1").value,
    cprR2: document.getElementById("cprR2").value,
    cprR3: document.getElementById("cprR3").value
  };
  try {
    localStorage.setItem("btcDcaSettingsV2", JSON.stringify(settings));
  } catch (e) {}
}

function loadSettings() {
  try {
    const raw = localStorage.getItem("btcDcaSettingsV2");
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.monthlyDca) document.getElementById("monthlyDca").value = s.monthlyDca;
    if (s.crashBudget) document.getElementById("crashBudget").value = s.crashBudget;
    if (s.ma200) document.getElementById("ma200").value = s.ma200;
    if (s.wma200) document.getElementById("wma200").value = s.wma200;
    if (s.spentThisMonth) document.getElementById("spentThisMonth").value = s.spentThisMonth;
    if (s.currentPrice) document.getElementById("currentPrice").value = s.currentPrice;
    if (s.cprBC) document.getElementById("cprBC").value = s.cprBC;
    if (s.cprPP) document.getElementById("cprPP").value = s.cprPP;
    if (s.cprTC) document.getElementById("cprTC").value = s.cprTC;
    if (s.cprS1) document.getElementById("cprS1").value = s.cprS1;
    if (s.cprS2) document.getElementById("cprS2").value = s.cprS2;
    if (s.cprS3) document.getElementById("cprS3").value = s.cprS3;
    if (s.cprR1) document.getElementById("cprR1").value = s.cprR1;
    if (s.cprR2) document.getElementById("cprR2").value = s.cprR2;
    if (s.cprR3) document.getElementById("cprR3").value = s.cprR3;
  } catch (e) {}
}

// BTC-Preis laden
async function fetchLivePrice() {
  const priceInput = document.getElementById("currentPrice");
  try {
    priceInput.value = "â€¦";
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    const price = data.bitcoin.eur;
    priceInput.value = Math.round(price);
  } catch (e) {
    alert("BTC-Preis konnte nicht geladen werden:\n" + e.message + "\nDu kannst ihn manuell eintragen.");
    priceInput.value = 0;
  }
  recalculate();
}

// Neuen Monat starten (DCA-ZÃ¤hler zurÃ¼cksetzen)
function resetForNewMonth() {
  if (!confirm("Neuen Monat starten?\nDies setzt nur den Wert 'TatsÃ¤chlich investiert im Monat' zurÃ¼ck. Dein Crash-Budget bleibt unverÃ¤ndert.")) {
    return;
  }
  document.getElementById("spentThisMonth").value = 0;
  recalculate();
}

// Empfohlenes Crashbudget Ã¼bernehmen
function applyRecommendedCrashBudget() {
  if (lastRecommendedCrashBudget === null) {
    alert("Es gibt derzeit kein berechnetes empfohlenes Crash-Budget.\nTrage zuerst Monatsbudget, Zone und tatsÃ¤chlich investierten Betrag ein.");
    return;
  }
  document.getElementById("crashBudget").value = Math.round(lastRecommendedCrashBudget);
  recalculate();
}

// DCA-Anteile leicht mit CPR-Bias anpassen
function adjustDcaPartsWithCpr(dcaLevels, cpr, zone) {
  if (!cpr.enabled) return;

  if (cpr.bias === "strongDown") {
    if (dcaLevels.length === 3) {
      dcaLevels[0].part = Math.max(0, dcaLevels[0].part - 0.05);
      dcaLevels[2].part += 0.05;
    } else if (dcaLevels.length === 4) {
      dcaLevels[0].part = Math.max(0, dcaLevels[0].part - 0.05);
      dcaLevels[2].part += 0.03;
      dcaLevels[3].part += 0.02;
    }
  } else if (cpr.bias === "strongUp") {
    if (dcaLevels.length === 3) {
      dcaLevels[0].part += 0.05;
      dcaLevels[2].part = Math.max(0, dcaLevels[2].part - 0.05);
    } else if (dcaLevels.length === 4) {
      dcaLevels[3].part = Math.max(0, dcaLevels[3].part - 0.05);
      dcaLevels[0].part += 0.03;
      dcaLevels[1].part += 0.02;
    }
  }
}

// Crash-Anteile mit CPR-Bias anpassen
function adjustCrashPartsWithCpr(parts, cpr) {
  if (!cpr.enabled) return;

  if (cpr.bias === "strongDown") {
    parts[0] = Math.max(0, parts[0] - 0.05);
    parts[3] += 0.05;
  } else if (cpr.bias === "strongUp") {
    parts[3] = Math.max(0, parts[3] - 0.05);
    parts[0] += 0.05;
  }
}

// Hauptlogik
function recalculate() {
  const monthlyDca = parseFloat(document.getElementById("monthlyDca").value) || 0;
  const crashBudget = parseFloat(document.getElementById("crashBudget").value) || 0;
  const price = parseFloat(document.getElementById("currentPrice").value) || 0;
  const ma200 = parseFloat(document.getElementById("ma200").value) || 0;
  const wma200 = parseFloat(document.getElementById("wma200").value) || 0;
  const spentThisMonth = parseFloat(document.getElementById("spentThisMonth").value) || 0;

  saveSettings();
  lastRecommendedCrashBudget = null;

  const cpr = getCprContext(price);

  // 1) Markt-Zone bestimmen
  const zoneInfo = document.getElementById("zoneInfo");
  const zoneCard = document.getElementById("zoneCard");
  let zoneText = "";
  let zoneBadge = "";
  let zone = "unknown";

  zoneCard.classList.remove("zone-normal", "zone-cheap", "zone-deep");

  if (price <= 0 || ma200 <= 0 || wma200 <= 0) {
    zoneText = "Bitte BTC-Preis, MA200 und 200WMA eintragen (z.B. aus TradingView, BTC/EUR).";
    zoneBadge = "<span class='badge badge-grey'>unbekannt</span>";
    zone = "unknown";
  } else {
    if (price < wma200) {
      zone = "deep";
      zoneCard.classList.add("zone-deep");
      zoneBadge = "<span class='badge badge-green'>DEEP â€“ historisch gÃ¼nstig (unter 200WMA)</span>";
      zoneText = "Bitcoin liegt UNTER dem 200-Wochen-Durchschnitt. Historisch eine der stÃ¤rksten Kaufzonen.";
    } else if (price < ma200) {
      zone = "cheap";
      zoneCard.classList.add("zone-cheap");
      zoneBadge = "<span class='badge badge-yellow'>GÃœNSTIG â€“ unter MA200</span>";
      zoneText = "Bitcoin liegt UNTER dem 200-Tage-Durchschnitt. Gute Zone fÃ¼r DCA + erste Crash-KÃ¤ufe.";
    } else {
      zone = "normal";
      zoneCard.classList.add("zone-normal");
      zoneBadge = "<span class='badge badge-grey'>NORMAL</span>";
      zoneText = "Bitcoin liegt ÃœBER dem MA200. Normaler/bullischer Bereich.";
    }
  }
  zoneInfo.innerHTML = zoneBadge + "<br>" + zoneText;

  // 2) DCA-Limit-Plan
  const tbodyLimit = document.querySelector("#limitTable tbody");
  tbodyLimit.innerHTML = "";
  let dcaLevels = [];
  const limitHintEl = document.getElementById("limitHint");

  if (price > 0 && monthlyDca > 0 && zone !== "unknown") {
    if (zone === "deep") {
      dcaLevels = [
        { label: "-3 %",  drop: 0.03, part: 0.25 },
        { label: "-6 %",  drop: 0.06, part: 0.25 },
        { label: "-10 %", drop: 0.10, part: 0.25 },
        { label: "-15 %", drop: 0.15, part: 0.25 }
      ];
    } else if (zone === "cheap") {
      dcaLevels = [
        { label: "-3 %",  drop: 0.03, part: 0.35 },
        { label: "-6 %",  drop: 0.06, part: 0.35 },
        { label: "-10 %", drop: 0.10, part: 0.30 }
      ];
    } else {
      dcaLevels = [
        { label: "-3 %",  drop: 0.03, part: 0.40 },
        { label: "-6 %",  drop: 0.06, part: 0.35 },
        { label: "-10 %", drop: 0.10, part: 0.25 }
      ];
    }

    adjustDcaPartsWithCpr(dcaLevels, cpr, zone);

    dcaLevels.forEach(l => {
      const limitPrice = price * (1 - l.drop);
      const amount = monthlyDca * l.part;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.label}</td>
        <td>${formatPrice(limitPrice)}</td>
        <td>${formatEuro(amount)}</td>
      `;
      tbodyLimit.appendChild(tr);
    });

    let hint = "Zu Monatsbeginn legst du diese Limit-Orders an (mit â€žPost Onlyâ€œ, wenn verfÃ¼gbar).";
    if (zone === "deep") {
      hint += "\nIn der Deep-Zone kommt das Extra-Limit bei âˆ’15 % dazu â€“ hier platzierst du bewusst einen Teil sehr tief.";
    }
    if (cpr.enabled && (cpr.bias === "strongDown" || cpr.bias === "strongUp")) {
      hint += "\nCPR-Bias wurde zur Feinverteilung verwendet: ";
      if (cpr.bias === "strongDown") {
        hint += "etwas mehr Budget wurde in tiefere DCA-Stufen geschoben.";
      } else {
        hint += "etwas mehr Budget wurde in die oberen DCA-Stufen geschoben.";
      }
    }
    limitHintEl.innerText = hint;
  } else {
    limitHintEl.innerText =
      "Bitte Monatsbudget, BTC-Preis und MA-Werte eintragen, um die Limit-Orders zu berechnen.";
  }

  // 3) Crash-Level-Plan (vom aktuellen Preis)
  const tbodyCrash = document.querySelector("#crashTable tbody");
  tbodyCrash.innerHTML = "";
  const crashHint = document.getElementById("crashHint");

  if (crashBudget <= 0 || price <= 0 || zone === "unknown") {
    crashHint.innerText =
      "FÃ¼r konkrete Crash-Levels trage bitte ein Crash-Budget, BTC-Preis und gÃ¼ltige MA-Werte ein.";
  } else {
    const baseLevels = [
      { label: "Level 1", dropLabel: "âˆ’20 %", drop: 0.20 },
      { label: "Level 2", dropLabel: "âˆ’30 %", drop: 0.30 },
      { label: "Level 3", dropLabel: "âˆ’40 %", drop: 0.40 },
      { label: "Level 4", dropLabel: "âˆ’50 %", drop: 0.50 }
    ];
    let parts;
    if (zone === "deep") {
      parts = [0.15, 0.20, 0.25, 0.40];
    } else if (zone === "cheap") {
      parts = [0.10, 0.25, 0.25, 0.40];
    } else {
      parts = [0.05, 0.20, 0.30, 0.45];
    }

    adjustCrashPartsWithCpr(parts, cpr);

    baseLevels.forEach((lvl, idx) => {
      const part = parts[idx];
      const levelPrice = price * (1 - lvl.drop);
      const amount = crashBudget * part;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${lvl.label}</td>
        <td>${lvl.dropLabel}</td>
        <td>${formatPrice(levelPrice)}</td>
        <td>${formatEuro(amount)}</td>
      `;
      tbodyCrash.appendChild(tr);
    });

    let txt = "Diese Tabelle zeigt dir, wie du dein Crash-Budget auf âˆ’20 %, âˆ’30 %, âˆ’40 % und âˆ’50 % vom aktuellen Preis verteilen kannst.\n";
    if (zone === "deep") {
      txt += "In der Deep-Zone ist der Einsatz aggressiver â€“ hier holen Crash-KÃ¤ufe historisch besonders viele Sats.\n";
    } else if (zone === "cheap") {
      txt += "In der gÃ¼nstigen Zone ist der Einsatz moderat â€“ du nutzt Crash-KÃ¤ufe, hÃ¤ltst aber Reserven fÃ¼r noch tiefere Phasen.\n";
    } else {
      txt += "In der Normal-Zone ist die Verteilung konservativer â€“ setze Crash-Budget nur bei echten, starken RÃ¼cksetzern ein.\n";
    }
    if (cpr.enabled && (cpr.bias === "strongDown" || cpr.bias === "strongUp")) {
      txt += "CPR-Bias wurde auch hier fÃ¼r die Verteilung genutzt: ";
      if (cpr.bias === "strongDown") {
        txt += "etwas mehr Budget liegt auf den tiefsten Crash-Leveln.";
      } else {
        txt += "etwas mehr Budget liegt auf den ersten Crash-Stufen.";
      }
    }
    crashHint.innerText = txt;
  }

  // 4) Restbudget-Manager (mit Bullrun-Option 2)
  const restHint = document.getElementById("restHint");
  if (monthlyDca <= 0) {
    restHint.innerText = "Trage zuerst dein monatliches DCA-Budget ein.";
  } else if (zone === "unknown" || price <= 0) {
    restHint.innerText = "Zone ist noch unbekannt. Bitte BTC-Preis, MA200 und 200WMA eintragen.";
  } else {
    let rest = monthlyDca - spentThisMonth;
    if (rest < 0) rest = 0;

    let restToCrash = 0;
    let restToMarketExtra = 0;

    if (zone === "normal") {
      if (spentThisMonth === 0) {
        // Bullrun-Option 2: 25 % Market, 75 % Crash
        restToMarketExtra = rest * 0.25;
        restToCrash = rest - restToMarketExtra;
      } else {
        // klassische Variante: Rest komplett ins Crash-Budget
        restToCrash = rest;
        restToMarketExtra = 0;
      }
    } else if (zone === "cheap") {
      restToCrash = rest * 0.5;
      restToMarketExtra = rest * 0.5;
    } else if (zone === "deep") {
      restToCrash = 0;
      restToMarketExtra = rest;
    }

    const newCrashBudget = crashBudget + restToCrash;
    lastRecommendedCrashBudget = newCrashBudget;

    let text =
      "Monatliches DCA-Budget: " + formatEuro(monthlyDca) + " â‚¬\n" +
      "TatsÃ¤chlich investiert (laut deiner Eingabe): " + formatEuro(spentThisMonth) + " â‚¬\n" +
      "Restbetrag: " + formatEuro(rest) + " â‚¬\n\n";

    if (zone === "normal") {
      if (spentThisMonth === 0) {
        text +=
          "Zone: NORMAL (Bullenmarkt-Szenario)\n" +
          "In diesem Monat scheint noch keine DCA-Order ausgelÃ¶st worden zu sein (eingetragen: 0 â‚¬).\n\n" +
          "Empfehlung (Option 2 â€“ Bullrun-Mindeskauf):\n" +
          "â€¢ Ca. 25 % des Monatsbudgets jetzt einmalig als Market-Kauf nutzen.\n" +
          "â€¢ Die Ã¼brigen ~75 % in dein Crash-Budget schieben.\n\n";
      } else {
        text +=
          "Zone: NORMAL\n" +
          "Empfehlung:\n" +
          "â€¢ Restbetrag vollstÃ¤ndig dem Crash-Budget zufÃ¼hren.\n" +
          "â€¢ ZusÃ¤tzliche Market-KÃ¤ufe sind hier nicht nÃ¶tig.\n\n";
      }
    } else if (zone === "cheap") {
      text +=
        "Zone: GÃœNSTIG (unter MA200)\n" +
        "Empfehlung:\n" +
        "â€¢ Ca. 50 % des Restbetrags als zusÃ¤tzlichen Market-Kauf verwenden.\n" +
        "â€¢ Ca. 50 % des Restbetrags in dein Crash-Budget verschieben.\n\n";
    } else if (zone === "deep") {
      text +=
        "Zone: DEEP (unter 200WMA)\n" +
        "Empfehlung:\n" +
        "â€¢ Den Restbetrag komplett als zusÃ¤tzlichen Market-Kauf nutzen.\n" +
        "â€¢ Crash-Budget hier lieber fÃ¼r die gestaffelten Crash-Levels (âˆ’20 % bis âˆ’50 %) aufheben.\n\n";
    }

    text +=
      "Empfohlene Aufteilung des Restbetrags:\n" +
      "â€¢ ZusÃ¤tzlicher Market-Kauf: " + formatEuro(restToMarketExtra) + " â‚¬\n" +
      "â€¢ Crash-Budget-ZufÃ¼hrung: " + formatEuro(restToCrash) + " â‚¬\n\n" +
      "Wenn du die Empfehlung Ã¼bernimmst, wÃ¤re dein neues Crash-Budget: " +
      formatEuro(newCrashBudget) + " â‚¬.\n" +
      "Per Button â€žEmpfohlenes Crash-Budget Ã¼bernehmenâ€œ kannst du diesen Wert direkt oben setzen.";

    restHint.innerText = text;
  }

  // 5) Konkrete Handlung (Zusammenfassung)
  const actionEl = document.getElementById("actionText");
  let action = "";

  if (price <= 0 || zone === "unknown") {
    action =
      "1. Trage BTC-Preis ein (per Button laden oder manuell).\n" +
      "2. Trage MA200 und 200WMA ein (z.B. aus TradingView, BTC/EUR).\n" +
      "3. Setze dann die DCA-Limits (âˆ’3 %, âˆ’6 %, âˆ’10 %, ggf. âˆ’15 %) gemÃ¤ÃŸ Tabelle.\n" +
      "4. Wenn du ein Crash-Budget hast, nutze die Crash-Level-Tabelle als Plan.\n" +
      "5. Am Monatsende trÃ¤gst du ein, wie viel du wirklich investiert hast â€“ dann sagt dir der Restbudget-Manager, was mit dem Rest passieren soll.";
  } else {
    if (zone === "normal") {
      action =
        "âšª Zone: NORMAL\n\n" +
        "Zu Monatsbeginn:\n" +
        "â€¢ Setze deine DCA-Limits bei âˆ’3 %, âˆ’6 % und âˆ’10 % gemÃ¤ÃŸ Tabelle.\n" +
        "â€¢ Setze Crash-Limit-Orders bei âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % mit den vorgeschlagenen BetrÃ¤gen.\n\n" +
        "Im Monatsverlauf:\n" +
        "â€¢ Lass die Limits arbeiten. In starken Bullenphasen kann es sein, dass keine DCA-Limits getroffen werden.\n\n" +
        "Am Monatsende:\n" +
        "â€¢ Wenn 0 â‚¬ investiert wurden, nutzt du ca. 25 % deines Monatsbudgets als einmaligen Market-Kauf und schiebst den Rest ins Crash-Budget.\n" +
        "â€¢ Wenn bereits etwas investiert wurde, geht der Restbetrag komplett ins Crash-Budget.\n";
    } else if (zone === "cheap") {
      action =
        "ðŸŸ¡ Zone: GÃœNSTIG (unter MA200)\n\n" +
        "Zu Monatsbeginn:\n" +
        "â€¢ Setze deine DCA-Limits wie angezeigt (mehr Gewicht auf die tieferen Stufen).\n" +
        "â€¢ Setze Crash-Limits bei âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 %.\n\n" +
        "Im Monatsverlauf:\n" +
        "â€¢ Normales DCA lÃ¤uft.\n" +
        "â€¢ Crash-KÃ¤ufe werden gestaffelt ausgelÃ¶st, wenn die Prozentmarken erreicht werden.\n\n" +
        "Am Monatsende:\n" +
        "â€¢ Restbetrag etwa 50/50 auf zusÃ¤tzlichen Market-Kauf und Crash-Budget verteilen.\n";
    } else if (zone === "deep") {
      action =
        "ðŸŸ¢ Zone: DEEP (unter 200WMA â€“ historisch sehr gÃ¼nstig)\n\n" +
        "Zu Monatsbeginn:\n" +
        "â€¢ Setze deine DCA-Limits bei âˆ’3 %, âˆ’6 %, âˆ’10 % und das Extra-Limit bei âˆ’15 %.\n" +
        "â€¢ Setze Crash-Limits bei âˆ’20 %, âˆ’30 %, âˆ’40 %, âˆ’50 % mit den vorgeschlagenen BetrÃ¤gen.\n\n" +
        "Im Monatsverlauf:\n" +
        "â€¢ Dies ist eine der stÃ¤rksten Zonen fÃ¼r langfristige BTC-KÃ¤ufe.\n" +
        "â€¢ DCA und Crash-KÃ¤ufe laufen parallel â€“ trotzdem gestaffelt bleiben und nicht alles auf einmal verfeuern.\n\n" +
        "Am Monatsende:\n" +
        "â€¢ Nutze den gesamten Restbetrag fÃ¼r zusÃ¤tzliche Market-KÃ¤ufe.\n" +
        "â€¢ Crash-Budget weiter fÃ¼r tiefe Crash-Level nutzen.\n";
    } else {
      action = "Zone unklar. PrÃ¼fe deine Eingaben.";
    }
  }
  actionEl.innerText = action;

  // 6) Smart-Assistent
  const assistantEl = document.getElementById("assistantText");
  const tips = [];
  const now = new Date();
  const day = now.getDate();

  if (zone === "normal") {
    tips.push("Du befindest dich in der NORMAL-Zone. Fokus: ruhiges DCA, Crash-Budget aufbauen und im Bullrun nicht hinterherjagen.");
  } else if (zone === "cheap") {
    tips.push("Du bist in einer GÃœNSTIGEN Zone (unter MA200). Historisch lohnt sich hier konsequentes DCA.");
  } else if (zone === "deep") {
    tips.push("DEEP-Zone: Das sind die Phasen, in denen langfristig die gÃ¼nstigsten Sats gekauft werden konnten. Nachkaufen tut mental weh, lohnt sich statistisch aber oft.");
  }

  if (cpr.enabled) {
    if (cpr.bias === "strongDown") {
      tips.push("CPR/Pivot-Bias: Stark abwÃ¤rtsorientiert. Tiefe DCA-Stufen und Crash-Level haben erhÃ¶hte Wahrscheinlichkeit, in den nÃ¤chsten Tagen/Wochen getroffen zu werden.");
    } else if (cpr.bias === "strongUp") {
      tips.push("CPR/Pivot-Bias: Stark aufwÃ¤rtsorientiert. Tiefste Crash-Level kÃ¶nnten lÃ¤nger unberÃ¼hrt bleiben â€“ deine oberen DCA-Stufen sind aktuell wichtiger.");
    }
  }

  if (monthlyDca > 0) {
    if (day <= 5) {
      tips.push("Monatsanfang (Tag " + day + "): Jetzt DCA-Limits und Crash-Limits neu setzen und dann einfach laufen lassen.");
    } else if (day >= 25 && spentThisMonth < monthlyDca) {
      if (zone === "normal" && spentThisMonth === 0) {
        tips.push("Monatsende, NORMAL-Zone und 0 â‚¬ investiert: Der Restbudget-Manager schlÃ¤gt dir jetzt vor, ca. 25 % deines Budgets als einmaligen Market-Kauf zu nutzen und den Rest ins Crash-Budget zu legen.");
      } else {
        tips.push("Monatsende nÃ¤hert sich: Du hast noch nicht dein volles DCA-Budget eingesetzt. Schau dir den Restbudget-Manager an.");
      }
    }
  }

  if (crashBudget > 0 && zone !== "deep") {
    tips.push("Du hast ein Crash-Budget, bist aber nicht in der Deep-Zone. Das ist okay â€“ Crash-Geld ist dafÃ¼r da, geduldig auf sehr gute Gelegenheiten zu warten.");
  } else if (crashBudget === 0 && (zone === "normal" || zone === "cheap")) {
    tips.push("Dein Crash-Budget ist aktuell 0 â‚¬. Ãœberlege, ob du langfristig etwas fÃ¼r starke RÃ¼cksetzer zurÃ¼cklegen mÃ¶chtest.");
  }

  if (tips.length === 0) {
    assistantEl.innerText = "Alles sieht stabil aus. Lass deine Limits arbeiten, halte deine Strategie ein und Ã¼berprÃ¼fe sie nur zu Monatsbeginn und Monatsende bewusst.";
  } else {
    assistantEl.innerText = tips.join("\n\n");
  }
}

// Events
window.addEventListener("load", () => {
  loadSettings();
  recalculate();

  ["monthlyDca","crashBudget","ma200","wma200","spentThisMonth","currentPrice",
   "cprBC","cprPP","cprTC","cprS1","cprS2","cprS3","cprR1","cprR2","cprR3"
  ].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", recalculate);
  });
});
</script>
</body>
</html>
