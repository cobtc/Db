<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bitcoin DCA & Crash-Assistent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #050505;
      color: #f7f7f7;
    }
    h1, h2 {
      color: #FFD700;
      margin-bottom: 0.5rem;
    }
    .card {
      border: 1px solid #333;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 16px;
      background: #111;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    input[type="number"], input[readonly] {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #000;
      color: #f7f7f7;
      font-size: 0.95rem;
    }
    input:focus {
      outline: none;
      border-color: #FFD700;
    }
    button {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #FFD700;
      background: #000;
      color: #FFD700;
      font-weight: 600;
      font-size: 1rem;
    }
    button:active {
      background: #222;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 120px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 4px;
    }
    .badge-green { background: #044; color: #8f8; }
    .badge-yellow { background: #443; color: #FFEB3B; }
    .badge-grey { background: #333; color: #bbb; }
    .small {
      font-size: 0.8rem;
      color: #aaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 4px 6px;
      text-align: right;
    }
    th {
      background: #151515;
      color: #ddd;
    }
    td:first-child, th:first-child {
      text-align: left;
    }
    .hint {
      font-size: 0.9rem;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <h1>‚Çø DCA & Crash-Assistent</h1>
  <p class="small">
    BTC-Preis wird automatisch geladen. MA200, 200WMA und das letzte Hoch tr√§gst du selbst ein (z.B. aus TradingView).
    Deine Einstellungen werden im Browser gespeichert.
  </p>

  <!-- 1. Basis-Einstellungen -->
  <div class="card">
    <h2>1. Basis-Einstellungen</h2>
    <label>Monatliches DCA-Budget (‚Ç¨)
      <input type="number" id="monthlyDca" value="310" step="1">
    </label>
    <div class="row">
      <div>
        <label>Crash-/Einmal-Budget (‚Ç¨)
          <input type="number" id="crashBankroll" value="0" step="50">
        </label>
      </div>
      <div>
        <label>Aktueller BTC-Preis (‚Ç¨) <span class="small">(per Button laden oder manuell setzen)</span>
          <input type="number" id="currentPrice" value="0" step="100" readonly>
        </label>
      </div>
    </div>
    <div class="row">
      <div>
        <label>MA200 (Tage, ‚Ç¨)
          <input type="number" id="ma200" value="" step="100">
        </label>
      </div>
      <div>
        <label>200WMA (Wochen, ‚Ç¨)
          <input type="number" id="wma200" value="" step="100">
        </label>
      </div>
    </div>
    <label>Letztes Hoch (f√ºr Crash-Level, ‚Ç¨) <span class="small">(letztes lokales Hoch, nicht zwingend ATH)</span>
      <input type="number" id="lastHigh" value="" step="100">
    </label>
    <button onclick="fetchLivePrice()">BTC-Preis laden</button>
  </div>

  <!-- 2. Markt-Zone & Crash-Ampel -->
  <div class="card">
    <h2>2. Markt-Zone & Crash-Ampel</h2>
    <div id="zoneInfo" class="hint"></div>
    <div id="crashMeter" class="hint"></div>
  </div>

  <!-- 3. Limit-DCA-Plan -->
  <div class="card">
    <h2>3. Limit-DCA-Plan (dieser Monat)</h2>
    <p class="small">Standard: 40 % / 35 % / 25 % auf ‚Äì3 %, ‚Äì6 %, ‚Äì10 % verteilt.</p>
    <table id="limitTable">
      <thead>
        <tr>
          <th>Stufe</th>
          <th>Preis (‚Ç¨)</th>
          <th>Betrag (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="hint" id="limitHint"></p>
  </div>

  <!-- 4. Crash-Level-Rechner -->
  <div class="card">
    <h2>4. Crash-Level-Rechner (vom letzten Hoch)</h2>
    <p class="small">
      Nutzt dein Crash-Budget und das letzte Hoch, um konkrete Kauf-Level zu berechnen.
      Die Verteilung wird je nach Markt-Zone konservativer oder aggressiver.
    </p>
    <table id="crashLevelsTable">
      <thead>
        <tr>
          <th>Level</th>
          <th>Fallh√∂he</th>
          <th>Kurs (‚Ç¨)</th>
          <th>Einsatz (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody id="crashLevelsBody"></tbody>
    </table>
    <p class="hint" id="crashLevelsHint"></p>
  </div>

  <!-- 5. Zonen-abh√§ngiger Einsatz-Plan -->
  <div class="card">
    <h2>5. Konkrete Handlung (Zonen-Plan)</h2>
    <div id="actionText" class="hint"></div>
  </div>

  <!-- 6. Monats-Plan -->
  <div class="card">
    <h2>6. Monats-Plan (Was du konkret tust)</h2>
    <div id="monthPlanText" class="hint"></div>
  </div>

<script>
function formatEuro(num) {
  if (isNaN(num)) return "-";
  return num.toLocaleString("de-DE", {minimumFractionDigits: 0, maximumFractionDigits: 0});
}
function formatPrice(num) {
  if (isNaN(num)) return "-";
  return num.toLocaleString("de-DE", {minimumFractionDigits: 0, maximumFractionDigits: 0});
}

// Einstellungen speichern / laden
function saveSettings() {
  const settings = {
    monthlyDca: document.getElementById("monthlyDca").value,
    crashBankroll: document.getElementById("crashBankroll").value,
    ma200: document.getElementById("ma200").value,
    wma200: document.getElementById("wma200").value,
    lastHigh: document.getElementById("lastHigh").value
  };
  try {
    localStorage.setItem("btcDcaSettings", JSON.stringify(settings));
  } catch (e) {}
}

function loadSettings() {
  try {
    const raw = localStorage.getItem("btcDcaSettings");
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.monthlyDca) document.getElementById("monthlyDca").value = s.monthlyDca;
    if (s.crashBankroll) document.getElementById("crashBankroll").value = s.crashBankroll;
    if (s.ma200) document.getElementById("ma200").value = s.ma200;
    if (s.wma200) document.getElementById("wma200").value = s.wma200;
    if (s.lastHigh) document.getElementById("lastHigh").value = s.lastHigh;
  } catch (e) {}
}

// BTC-Preis laden
async function fetchLivePrice() {
  const priceInput = document.getElementById("currentPrice");
  try {
    priceInput.value = "‚Ä¶";
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    const price = data.bitcoin.eur;
    priceInput.value = Math.round(price);
  } catch (e) {
    priceInput.value = 0;
    alert("BTC-Preis konnte nicht geladen werden:\n" + e.message + "\nDu kannst ihn manuell eintragen.");
  }
  recalculate();
}

// Hauptlogik
function recalculate() {
  const monthlyDca = parseFloat(document.getElementById("monthlyDca").value) || 0;
  const crashBankroll = parseFloat(document.getElementById("crashBankroll").value) || 0;
  const price = parseFloat(document.getElementById("currentPrice").value) || 0;
  const ma200 = parseFloat(document.getElementById("ma200").value) || 0;
  const wma200 = parseFloat(document.getElementById("wma200").value) || 0;
  const lastHigh = parseFloat(document.getElementById("lastHigh").value) || 0;

  saveSettings();

  // 1) Markt-Zone
  const zoneInfo = document.getElementById("zoneInfo");
  const crashMeter = document.getElementById("crashMeter");
  let zoneText = "";
  let zoneBadge = "";
  let zone = "normal";

  if (price <= 0 || ma200 <= 0 || wma200 <= 0) {
    zoneText = "Bitte BTC-Preis, MA200 und 200WMA eintragen. MA-Werte kannst du z.B. aus TradingView holen.";
    zoneBadge = "<span class='badge badge-grey'>unbekannt</span>";
  } else {
    if (price < wma200) {
      zone = "deep";
      zoneBadge = "<span class='badge badge-green'>GR√úN ‚Äì historische Tiefzone (unter 200WMA)</span>";
      zoneText = "Bitcoin liegt UNTER dem 200-Wochen-Durchschnitt. Historisch eine der st√§rksten Kaufzonen.";
    } else if (price < ma200) {
      zone = "cheap";
      zoneBadge = "<span class='badge badge-yellow'>G√úNSTIG ‚Äì unter MA200</span>";
      zoneText = "Bitcoin liegt UNTER dem 200-Tage-Durchschnitt. Gute Zone f√ºr DCA + kleinere Crash-K√§ufe.";
    } else {
      zone = "normal";
      zoneBadge = "<span class='badge badge-grey'>NORMAL</span>";
      zoneText = "Bitcoin liegt √úBER dem MA200. Normaler/bullischer Bereich.";
    }
  }
  zoneInfo.innerHTML = zoneBadge + "<br>" + zoneText;

  // 2) Crash-Ampel (Abstand vom letzten Hoch)
  if (lastHigh > 0 && price > 0) {
    const dropPct = ((lastHigh - price) / lastHigh) * 100;
    if (dropPct <= 0) {
      crashMeter.innerText =
        "Crash-Ampel: Aktueller Kurs liegt auf oder √ºber deinem letzten Hoch. Noch kein R√ºcksetzer relativ zu diesem Hoch.";
    } else {
      const dropRounded = dropPct.toFixed(1);
      let mood;
      if (dropPct < 10) {
        mood = "Leichter R√ºcksetzer ‚Äì noch kein klassischer Crash.";
      } else if (dropPct < 20) {
        mood = "Sp√ºrbarer R√ºckgang ‚Äì interessante DCA-Zone, aber noch vor Crash-Level 1 (‚àí20 %).";
      } else if (dropPct < 30) {
        mood = "Crash-Level 1 (‚âà ‚àí20 %) ist erreicht oder √ºberschritten. Erste Crashk√§ufe werden relevant.";
      } else if (dropPct < 40) {
        mood = "Zwischen Crash-Level 2 und 3 ‚Äì deutlicher Crashbereich.";
      } else {
        mood = "Starker Crash (√ºber ‚àí40 % vom letzten Hoch).";
      }
      crashMeter.innerText =
        "Crash-Ampel: Wir sind ca. " + dropRounded.replace(".", ",") +
        " % unter deinem letzten Hoch.\n" + mood;
    }
  } else {
    crashMeter.innerText =
      "Crash-Ampel: Trage ein letztes Hoch ein, um zu sehen, wie weit der Markt aktuell davon entfernt ist.";
  }

  // 3) Limit-DCA-Plan (‚Äì3 / ‚Äì6 / ‚Äì10)
  const tbodyLimit = document.querySelector("#limitTable tbody");
  tbodyLimit.innerHTML = "";
  let limitLevels = [];
  if (price > 0 && monthlyDca > 0) {
    limitLevels = [
      { label: "-3 %", drop: 0.03, part: 0.40 },
      { label: "-6 %", drop: 0.06, part: 0.35 },
      { label: "-10 %", drop: 0.10, part: 0.25 }
    ];
    limitLevels.forEach(l => {
      l.limitPrice = price * (1 - l.drop);
      l.amount = monthlyDca * l.part;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${l.label}</td>
        <td>${formatPrice(l.limitPrice)}</td>
        <td>${formatEuro(l.amount)}</td>
      `;
      tbodyLimit.appendChild(tr);
    });
    document.getElementById("limitHint").innerText =
      "Diese Limit-Orders legst du zu Monatsbeginn an (mit Post Only). Am Monatsende kaufst du den Restbetrag als Market-Order, falls nicht alle Limits ausgel√∂st wurden.";
  } else {
    document.getElementById("limitHint").innerText =
      "Bitte Monatsbudget und BTC-Preis eintragen, um die Limit-Orders zu berechnen.";
  }

  // 4) Crash-Level-Rechner (vom letzten Hoch)
  const tbodyCrashLevels = document.getElementById("crashLevelsBody");
  const crashLevelsHint = document.getElementById("crashLevelsHint");
  tbodyCrashLevels.innerHTML = "";

  if (crashBankroll <= 0 || lastHigh <= 0) {
    crashLevelsHint.innerText =
      "F√ºr konkrete Crash-Levels trage bitte ein Crash-Budget und ein letztes Hoch ein.";
  } else {
    let factors;
    if (zone === "deep") {
      // Aggressiver Einsatz, wenn wir schon unter 200WMA sind
      factors = [
        { label: "Level 1", dropLabel: "‚àí20 %", drop: 0.20, part: 0.15 },
        { label: "Level 2", dropLabel: "‚àí30 %", drop: 0.30, part: 0.20 },
        { label: "Level 3", dropLabel: "‚àí40 %", drop: 0.40, part: 0.25 },
        { label: "Level 4", dropLabel: "‚àí50 %", drop: 0.50, part: 0.40 }
      ];
    } else {
      // Defensivere Standardverteilung
      factors = [
        { label: "Level 1", dropLabel: "‚àí20 %", drop: 0.20, part: 0.10 },
        { label: "Level 2", dropLabel: "‚àí30 %", drop: 0.30, part: 0.20 },
        { label: "Level 3", dropLabel: "‚àí40 %", drop: 0.40, part: 0.30 },
        { label: "Level 4", dropLabel: "‚àí50 %", drop: 0.50, part: 0.40 }
      ];
    }

    factors.forEach(f => {
      const levelPrice = lastHigh * (1 - f.drop);
      const amount = crashBankroll * f.part;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${f.label}</td>
        <td>${f.dropLabel}</td>
        <td>${formatPrice(levelPrice)}</td>
        <td>${formatEuro(amount)}</td>
      `;
      tbodyCrashLevels.appendChild(tr);
    });

    crashLevelsHint.innerText =
      "Diese Tabelle zeigt dir, bei welchen Kursen (vom letzten Hoch aus) du wie viel von deinem Crash-Budget einplanen kannst.";
  }

  // 5) Zonen-abh√§ngiger Einsatz-Plan (Konkrete Handlung)
  const actionEl = document.getElementById("actionText");
  let action = "";

  if (price <= 0) {
    action = "Bitte zuerst BTC-Preis laden (Button) oder manuell eintragen, dann MA200, 200WMA und letztes Hoch setzen.";
  } else if (zone === "normal") {
    action =
      "‚ö™ Zone: NORMAL\n\n" +
      "‚Ä¢ DCA: Nutze dein Monatsbudget mit der 3er-Limitstaffel (‚àí3 %, ‚àí6 %, ‚àí10 %).\n" +
      "‚Ä¢ Crash-Budget: Nur beobachten, nicht aggressiv einsetzen.\n" +
      "‚Ä¢ Fokus: Langfristig weiterkaufen, ohne dich von kleineren Schwankungen verr√ºckt machen zu lassen.";
  } else if (zone === "cheap") {
    action =
      "üü° Zone: G√úNSTIG (unter MA200)\n\n" +
      "‚Ä¢ DCA: Monats-Limits normal setzen.\n" +
      "‚Ä¢ Crash-Budget: Kleine Teilbetr√§ge kannst du bei tieferen R√ºcksetzern nutzen (siehe Crash-Level-Tabelle).\n" +
      "‚Ä¢ Fokus: Ruhig bleiben, Setup weiterfahren, nicht das gesamte Crash-Budget zu fr√ºh verbraten.";
  } else if (zone === "deep") {
    action =
      "üü¢ Zone: HISTORISCH G√úNSTIG (unter 200WMA)\n\n" +
      "‚Ä¢ DCA: Monatsbudget weiter mit Limits nutzen.\n" +
      "‚Ä¢ Crash-Budget: Je nach Gef√ºhl kannst du die in der Tabelle vorgeschlagenen Level (‚àí20 % bis ‚àí50 %) ernsthaft bespielen.\n" +
      "‚Ä¢ Fokus: Langfristig beste Zonen, aber trotzdem gestaffelt vorgehen ‚Äì nie alles auf einmal.";
  } else {
    action = "Keine klare Zone erkannt. Pr√ºfe BTC-Preis, MA200 und 200WMA.";
  }
  actionEl.innerText = action;

  // 6) Monats-Plan Text
  const monthPlanEl = document.getElementById("monthPlanText");
  let monthPlan = "";

  if (price <= 0 || monthlyDca <= 0) {
    monthPlan =
      "Monats-Plan kann noch nicht berechnet werden.\n" +
      "Trage mindestens BTC-Preis und dein Monatsbudget ein.";
  } else {
    const totalLimitAmount = limitLevels.reduce((sum, l) => sum + (l.amount || 0), 0);
    const rest = monthlyDca - totalLimitAmount;
    const restRounded = Math.max(0, Math.round(rest));

    monthPlan = "Zu Monatsbeginn:\n";

    if (limitLevels.length === 3) {
      monthPlan +=
        "‚Ä¢ Lege 3 Limit-Orders an:\n" +
        "  - " + limitLevels[0].label + ": ca. " + formatPrice(limitLevels[0].limitPrice) + " ‚Ç¨ mit " + formatEuro(limitLevels[0].amount) + " ‚Ç¨\n" +
        "  - " + limitLevels[1].label + ": ca. " + formatPrice(limitLevels[1].limitPrice) + " ‚Ç¨ mit " + formatEuro(limitLevels[1].amount) + " ‚Ç¨\n" +
        "  - " + limitLevels[2].label + ": ca. " + formatPrice(limitLevels[2].limitPrice) + " ‚Ç¨ mit " + formatEuro(limitLevels[2].amount) + " ‚Ç¨\n";
    } else {
      monthPlan += "‚Ä¢ Limit-Staffel konnte nicht berechnet werden. Pr√ºfe BTC-Preis und Budget.\n";
    }

    monthPlan += "\nAm Monatsende:\n";
    if (restRounded > 0) {
      monthPlan +=
        "‚Ä¢ Pr√ºfe, wie viele Limits ausgel√∂st wurden.\n" +
        "‚Ä¢ Den Restbetrag (~" + formatEuro(restRounded) + " ‚Ç¨) kannst du als Market-Order nachkaufen.\n";
    } else {
      monthPlan +=
        "‚Ä¢ Falls alle Limits ausgel√∂st wurden, musst du nichts weiter tun.\n";
    }

    monthPlan += "\nCrash-Budget:\n";
    if (crashBankroll <= 0) {
      monthPlan +=
        "‚Ä¢ Aktuell kein Crash-Budget hinterlegt. Wenn du extra Geld (z.B. aus ETF-Verkauf) zur Seite legen m√∂chtest, trage es oben ein.\n";
    } else {
      if (zone === "normal") {
        monthPlan +=
          "‚Ä¢ Halte dein Crash-Budget trocken. Nur bei wirklich deutlichen R√ºcksetzern (siehe Crash-Levels) langsam einsetzen.\n";
      } else if (zone === "cheap") {
        monthPlan +=
          "‚Ä¢ Du kannst erste kleine Positionen gem√§√ü Crash-Level-Tabelle nutzen, aber nicht alles auf einmal.\n";
      } else if (zone === "deep") {
        monthPlan +=
          "‚Ä¢ In dieser Zone ist dein Crash-Budget besonders wertvoll. Nutze die Tabelle, um gestaffelt bei ‚àí20 %, ‚àí30 %, ‚àí40 %, ‚àí50 % zuzukaufen.\n";
      } else {
        monthPlan +=
          "‚Ä¢ Zone unklar. Nutze Crash-Budget nur sehr vorsichtig oder warte auf klarere Signale.\n";
      }
    }
  }

  monthPlanEl.innerText = monthPlan;
}

// Events
window.addEventListener("load", () => {
  loadSettings();
  recalculate();

  ["monthlyDca","crashBankroll","ma200","wma200","lastHigh"].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", recalculate);
  });
});
</script>
</body>
</html>
